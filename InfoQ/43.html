<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8" /></head><body><h3>环境特定的构建工具：Grunt、Gulp和Broccoli</h3><p>项目的开发、分期和产品版本之间可能会有巨大的改变，这是我们需要基于环境以及特定目标信息改变资源（脚本、样式、模板）、生成标记或者其他内容路径的原因之一。很幸运的是，在Grunt、Gulp和Broccolli生态系统中已经有很多构建工具能够帮助我们完成这些工作。不久之前来自于Google Chrome开发者关系团队的工程师Addy Osmani对解决该问题的三种方式（字符串替代、条件注释和模板变量）做了<a href="http://addyosmani.com/blog/environment-specific-builds-with-grunt-gulp-or-broccoli/">对比</a>。</p>
<h2>最简单的选项—字符串/正则表达式替换</h2>
<p>对于环境特定的输出，最简单的选项是使用字符串替换，通过一个简单的字符串或者正则表达式找出并移除/替代HTML文件中的块。构建文件中可能会有很多目标设置，其中的每一个都能够用任意内容替换字符串。</p>
<p>例如，在Grunt中使用<a href="https://github.com/erickrdch/grunt-string-replace">grunt-string-replace</a>的一个非常基础的例子可能是在prod构建的时候将字符串source.js替换为build.js，如下所示：</p>
<pre>
module.exports = function(grunt) {
  grunt.initConfig({
    'string-replace': {
      prod: {
        src: './app/**/*.html',
        dest: './dist/',
        options: {
          replacements: [{
            pattern: 'source.js',
            replacement: 'build.js'
          }]
        }
      }
    }
  });
  grunt.loadNpmTasks('grunt-string-replace');
  grunt.registerTask('default', ['string-replace']);
};</pre>
<p>（<a href="https://github.com/outaTiME/grunt-replace">grunt-replace</a> 也能很好的满足这种场景）</p>
<p>一般情况下，文本替换的方式需要少量配置，像Stephen Sawchuk（Yeoman和Bower的一位贡献者，他认为对于自己的设置而言其他的替代方案过于复杂）这样的开发人员会使用这种方式。从这个<a href="https://gist.github.com/stephenplusplus/523314c4bdda1a8ad1c0">gist</a>中你可以找到他在项目中是如何使用字符串替换的。</p>
<p>如果你并没有使用Grunt，那么等价方案还有<a href="https://github.com/lazd/gulp-replace">gulp-replace</a>和<a href="https://github.com/outaTiME/broccoli-replace">broccoli-replace</a>。</p>
<p>对于简单的场景而言，字符串替换能够很好地完成工作，例如需要更新或者删除多个文件中的一组字符串。但是如果你有大量需要替换的内容，同时需要在源文件和构建文件之间来回跳转以便于算出到底需要替换哪些内容时，这种方式就会变得难以维护。</p>
<p>对于这种场景更好的解决方案是在源文件中就地定义替代品。也就是下面的选项。</p>
<h2>条件注释</h2>
<p>环境条件注释的基本思想是：在构建文件中通过最少的配置、使用HTML注释语法定义将一个字符串替代为目标内容所需要的逻辑和信息（例如路径）。这种方案的可读性比较好，同时也能够很容易地在每一个文件中实现。</p>
<p>下面是一些可选方案：</p>
<p>Grunt：</p>
<ul> 
 <li><a href="https://npmjs.org/package/grunt-targethtml/">grunt-targethtml</a></li> 
 <li><a href="https://npmjs.org/package/grunt-preprocess/">grunt-preprocess</a></li> 
 <li><a href="https://npmjs.org/package/grunt-processhtml/">grunt-processhtml</a></li> 
</ul>
<p>Gulp：</p>
<ul> 
 <li><a href="https://npmjs.org/package/gulp-preprocess/">gulp-preprocess</a></li> 
 <li><a href="https://npmjs.org/package/gulp-processhtml/">gulp-processhtml</a></li> 
</ul>
<p>该列表前三个选项的注释语法在可读性和冗余度方面有所差异，但是它们都能有效地实现同样的结果。所有的选项都能够毫不费力地输出目标/环境特定的块，首先让我们来比较一下targethtml和preprocess：</p>
<p><strong>一个</strong><code><b>grunt-targethtml</b></code> <strong>示例</strong><strong> (Dev vs. Production)</strong></p>
<pre>
Dev：
&lt;!--(if target dev)&gt;&lt;!--&gt;
 &lt;link rel=&quot;stylesheet&quot; href=&quot;dev.css&quot; /&gt;
&lt;!--&lt;!(endif)--&gt;
&lt;!--(if target dev)&gt;&lt;!--&gt;
  &lt;script src=&quot;dev.js&quot;&gt;&lt;/script&gt;
  &lt;script&gt;
    var less = { env:'development' };
  &lt;/script&gt;
&lt;!--&lt;!(endif)--&gt;
Production：
&lt;!--(if target prod)&gt;&lt;!--&gt;
  &lt;link rel=&quot;stylesheet&quot; href=&quot;release.css&quot;&gt;
&lt;!--&lt;!(endif)--&gt;
&lt;!--(if target prod)&gt;&lt;!--&gt;
   &lt;script src=&quot;release.js&quot;&gt;&lt;/script&gt;
&lt;!--&lt;!(endif)--&gt;</pre>
<p><strong>同样的</strong><code><b>grunt-processhtml</b></code></p>
<pre>
Dev：
&lt;!-- @if NODE_ENV='production' --&gt;
 &lt;link rel=&quot;stylesheet&quot; href=&quot;dev.css&quot;&gt;
&lt;!-- @endif --&gt;
&lt;!-- @if NODE_ENV='production' --&gt;
&lt;script src=&quot;dev.js&quot;&gt;&lt;/script&gt;
&lt;script&gt;
  var less = { env:'development' };
&lt;/script&gt;
&lt;!-- @endif --&gt;

Production：
&lt;!-- @if NODE_ENV='production' --&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;release.css&quot;&gt;
&lt;!-- @endif --&gt;
&lt;!-- @if NODE_ENV='production' --&gt;
&lt;script src=&quot;release.js&quot;&gt;&lt;/script&gt;
&lt;!-- @endif --&gt;</pre>
<p>正如我们所看到的，按照注释的形式指定逻辑相当直接，这种方式已经被大量地使用，并没有太多的抱怨。</p>
<p>使用条件注释的一个主要缺点是：标记文件中可能会包含大量与构建相关的逻辑。虽然有一些开发人员不喜欢这样，但是这些任务提供了可读性流。这也意味着我们没必要跳回Gruntfile中查看它到底正在干什么。</p>
<p>之前列出了3个Grunt任务，那么grunt-processhtml怎么样呢？它有一点专业，你可以使用模板变量以及其他的一些不错的技巧包含完全不同的文件。</p>
<p>例如，在下面的例子中只有当“dist”目标运行的时候才会将class修改为“production”：</p>
<pre>
&lt;!-- build:[class]:dist production --&gt;
&lt;html class=&quot;debug_mode&quot;&gt;
&lt;!-- /build --&gt;</pre>
<p>或者使用任意一个文件替换目标中的一个块：</p>
<pre>
&lt;!-- build:include:dev dev/content.html --&gt;
This will be replaced by the content of dev/content.html
&lt;!-- /build --&gt;</pre>
<p>或者根据目标删除一个块：</p>
<pre>
&lt;!-- build:remove --&gt;
&lt;p&gt;This will be removed when any processhtml target is done&lt;/p&gt;
&lt;!-- /build --&gt;
&lt;!-- build:remove:dist --&gt;
&lt;p&gt;But this one only when doing processhtml:dist target&lt;/p&gt;
&lt;!-- /build --&gt;</pre>
<p>如果确定需要配置代码注释块格式的能力，那么可以查看 <a href="https://npmjs.org/package/grunt-devcode/">grunt-devcode</a> ，它支持这些。下面是一些示例配置：</p>
<pre>
Gruntfile：
Devcode：
    {
      options :
      {
        html: true,        // html files parsing?
        js: true,          // javascript files parsing?
        css: true,         // css files parsing?
        clean: true,
        block: {
          open: 'condition', // open code block
          close: 'conditionend' // close code block
        },
        dest: 'dist'
      },
Markup：
&lt;!-- condition: !production --&gt;
  &lt;li class=&quot;right&quot;&gt;
    &lt;a href=&quot;#settings&quot; data-toggle=&quot;tab&quot;&gt;
      Settings
    &lt;/a&gt;
  &lt;/li&gt;
&lt;!-- conditionend --&gt;</pre>
<p>如果你想利用占位符的方式实现，那么可以借助于模板变量。</p>
<h2>HTML中的模板变量</h2>
<p>构建时模板允许我们将源文件中定义的占位符字符串（例如&lt;%- title %&gt;）替换为构建文件（例如Gruntfile）中定义的与特定目标相关的数据（字符串、对象等任何你需要的内容）。与条件注释相比，使用这种方式时你注入的数据并不是在目标文件本身中指定的。这种类型的选项有：</p>
<p>Grunt：</p>
<ul> 
 <li><a href="https://npmjs.org/package/grunt-template/">grunt-template</a></li> 
 <li><a href="https://npmjs.org/package/grunt-include-replace/">grunt-include-replace</a></li> 
</ul>
<p>Gulp：</p>
<ul> 
 <li><a href="https://npmjs.org/package/gulp-template/">gulp-template</a></li> 
</ul>
<p>grunt-template基本上是对grunt.template.process()的包装。同时它主要针对的是基于目标的目标字符串操作，你可以通过data 对象根据dev/prod目标改变路径或者内容。下面就是一个这样的例子：</p>
<pre>
index.html.tpl

Gruntfile.js
module.exports = function(grunt) {
    grunt.initConfig({
        'template': {
            'dev': {
                'options': {
                    'data': {
                        'title': 'I &lt;3 JS in dev'
                    }
                },
                'files': {
                    'dev/index.html': ['src/index.html.tpl']
                }
            },
            'prod': {
                'options': {
                    'data': {
                        'title': 'I &lt;3 JS in prod'
                    }
                },
                'files': {
                    'dist/index.html': ['src/index.html.tpl']
                }
            }
        }
    });
    grunt.loadNpmTasks('grunt-template');
    grunt.registerTask('default', [
        'template:prod'
    ]);
    grunt.registerTask('dev', [
        'template:dev'
    ]);
};</pre>
<p>grunt-include-replace 做的事情比较相似，只是模板字符串的格式不同(&lt;title&gt;@@title&lt;/title&gt;)。</p><br><br><br><br><br><br></body></html>