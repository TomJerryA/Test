<html><head><meta http-equiv="content-type" content="text/html; charset=utf-8" /></head><body><h3>如何审查合并的提交</h3><p>近日，苹果公司新发布的<a href="http://support.apple.com/kb/HT6147">iOS 7.0.6</a>一度闹得沸沸扬扬，这是由于它修复了一个<a href="https://www.imperialviolet.org/2014/02/22/applebug.html">因goto而引起的bug</a>。对于广大开发者来说，这个bug出现的原因以及如何避免其出现，成了热议的话题。</p>
<p>知名博主<a href="http://weibo.com/haoel">陈皓</a>分享了他对于该事件的<a href="http://coolshell.cn/articles/11112.html">思考</a>。他认为这可能是代码在合并过程中导致的bug，而这种bug却很难在代码审查时被发现。</p>
<p>前微软工程师，现就职于<a href="http://github.com">Github</a>的<a href="http://haacked.com/">Phil Haack</a>在其博客中分享了他的团队是<a href="http://haacked.com/archive/2014/02/21/reviewing-merge-commits/">如何审查合并提交</a>的。在此前，他们的合并流程是这样的（假设要将master分支合并到long-running-branch分支上）：</p>
<ol> 
 <li>在long-running-branch分支上创建一个新的分支：merge-master-into-long-running-branch。</li> 
 <li>在该分支上执行合并。</li> 
 <li>将该分支推送（push）到Github上。</li> 
 <li>根据该提交创建一个拉请求（pull request），请团队其他人进行审查。</li> 
</ol>
<p>在git中，这相当于执行下面的命令集：</p>
<pre>
git checkout long-running-branch
git checkout -b merge-master-into-long-running-branch
git merge master
# Manually do a lot of work to resolve the conflicts and commit those changes
git push origin merge-master-into-long-running-branch
</pre>
<p>然而这样的方式可能会产生问题。Phil的同事<a href="http://paulbetts.org/">Paul Betts</a>指出，在将一个分支合并到另一个的时候，该合并提交的diff将显示从最后一次合并之后的所有改变。这很可能是已经审查过的代码。而我们真正想要看到的，是这次提交是否有冲突，以及如何解决这些冲突。</p>
<p>参与<a href="https://github.com/libgit2/libgit2">LibGit2</a>开发的<a href="https://github.com/arrbee">Russell Belfer</a>给出了答案。</p>
<p>在将一个分支合并到另一个分支时，会在这两个分支上各创建一个合并提交。以<a href="https://github.com/SignalR/SignalR">SignalR</a>的<a href="https://github.com/SignalR/SignalR/commit/cc5b002a5140e2d60184de42554a8737981c846c">一次合并提交</a>为例。该提交要将release分支合并到dev分支，该提交的SHA为cc5b002a5140e2d60184de42554a8737981c846c，以cc5b002a代替。</p>
<p>我们可以使用git diff命令，从两个父分支上分别查看这个合并。例如：</p>
<pre>
git diff cc5b002a^1 cc5b002a
git diff cc5b002a^2 cc5b002a
</pre>
<p>如果只想查看冲突的部分，可以使用git show命令：</p>
<pre>
git show --cc cc5b002a
</pre>
<p><a href="https://gist.github.com/Haacked/9192002">git show所展示的内容</a>，要比<a href="https://github.com/SignalR/SignalR/commit/cc5b002a5140e2d60184de42554a8737981c846c">整个合并提交的diff</a>少得多，因为--cc选项可以忽略没有冲突的部分，即只显示与该提交的所有父分支都不相同的部分。这样，审阅者就可以更加专注于冲突的部分，从而降低bug发生的概率。</p>
<p>Phil在文章最后介绍了他是如何发现这样一个合并冲突的示例的。他执行了git log --min-parents=2 -p --cc命令，从而找出了至少有两个父分支的提交。</p><br><br><br><br><br><br></body></html>